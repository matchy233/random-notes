<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AWS Amplify Attempts - Random Notes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Random Notes</a></li><li class="chapter-item expanded affix "><li class="part-title">Literature</li><li class="chapter-item expanded "><a href="../literature/quotes.html"><strong aria-hidden="true">1.</strong> Random Quotes</a></li><li class="chapter-item expanded "><a href="../literature/lyrics.html"><strong aria-hidden="true">2.</strong> Lyrics Quotes</a></li><li class="chapter-item expanded "><a href="../literature/poems.html"><strong aria-hidden="true">3.</strong> Poem Excerpts</a></li><li class="chapter-item expanded affix "><li class="part-title">Java</li><li class="chapter-item expanded "><a href="../Java/Java-io.html"><strong aria-hidden="true">4.</strong> Java IO</a></li><li class="chapter-item expanded affix "><li class="part-title">Reverse Engineering</li><li class="chapter-item expanded "><a href="../RevEng/gdb.html"><strong aria-hidden="true">5.</strong> Intro to gdb</a></li><li class="chapter-item expanded "><a href="../RevEng/ascii-asm.html"><strong aria-hidden="true">6.</strong> ASCII shellcode (WIP)</a></li><li class="chapter-item expanded affix "><li class="part-title">DevOps</li><li class="chapter-item expanded "><a href="../devops/hadoop-on-k8s.html"><strong aria-hidden="true">7.</strong> Haddop in K8S</a></li><li class="chapter-item expanded "><a href="../devops/aws-amplify.html" class="active"><strong aria-hidden="true">8.</strong> AWS Amplify Attempts</a></li><li class="chapter-item expanded affix "><li class="part-title">Linux</li><li class="chapter-item expanded "><a href="../Linux/disk-management.html"><strong aria-hidden="true">9.</strong> Disk Management</a></li><li class="chapter-item expanded "><a href="../Linux/net-forwarding.html"><strong aria-hidden="true">10.</strong> Internet Sharing</a></li><li class="chapter-item expanded affix "><li class="part-title">Terminal Usage</li><li class="chapter-item expanded "><a href="../Terminal/effective-shell.html"><strong aria-hidden="true">11.</strong> Effective Shell 1</a></li><li class="chapter-item expanded "><a href="../Terminal/tmux.html"><strong aria-hidden="true">12.</strong> TMUX 101</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../misc/fix-node-modules.html"><strong aria-hidden="true">13.</strong> Fix node-modules</a></li><li class="chapter-item expanded "><a href="../misc/use-wsl-with-gui.html"><strong aria-hidden="true">14.</strong> Use WSL with GUI</a></li><li class="chapter-item expanded "><a href="../misc/gpg.html"><strong aria-hidden="true">15.</strong> GPG</a></li><li class="chapter-item expanded "><a href="../misc/sukhoi-fighters.html"><strong aria-hidden="true">16.</strong> Flankerology 101</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Random Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="aws-amplify-踩坑记录"><a class="header" href="#aws-amplify-踩坑记录">AWS Amplify 踩坑记录🕳</a></h1>
<p>我也不知道这算不算 DevOps</p>
<h2 id="试图从-staging-clone-出一个配置一样的-dev-环境"><a class="header" href="#试图从-staging-clone-出一个配置一样的-dev-环境">试图从 staging clone 出一个配置一样的 dev 环境</a></h2>
<h3 id="被坑过程"><a class="header" href="#被坑过程">被坑过程</a></h3>
<p>Amplify backend 已有 staging，想直接再 Amplify Console clone 失败了， 出来一份空的 :/</p>
<p>在本地有 staging backend 配置表的分支 development 上拉取 dev environment:</p>
<pre><code class="language-shell">amplify pull --appId &lt;appId&gt; --envName dev
</code></pre>
<p>之后进行 push，提示 <code>HostedUIProvidersCustomResourceInputs</code> update 失败。</p>
<pre><code class="language-shell">Embedded stack arn:aws:cloudformation:&lt;myapp&gt; was not successfully updated. Currently in UPDATE_ROLLBACK_IN_PROGRESS with reason: The following resource(s) failed to update: [HostedUIProvidersCustomResourceInputs].
</code></pre>
<p>谷歌到 <a href="https://github.com/aws-amplify/amplify-cli/issues/3798">这个 issue</a>，提示可能是 <code>tream-provider-info.json</code> 里缺 <code>auth</code> 内容。看了一下果然是空的。</p>
<p>在 JSON 里添加 <code>auth</code> 相关字段。</p>
<pre><code class="language-json">{
  ...
  &quot;categories&quot;: {
      &quot;auth&quot;: {
        &quot;&lt;appName&gt;&quot;: {
          &quot;userPoolId&quot;: &quot;...&quot;,
          &quot;userPoolName&quot;: &quot;...&quot;,
          &quot;webClientId&quot;: &quot;...&quot;,
          &quot;nativeClientId&quot;: &quot;...&quot;
        }
      }
    }
}
</code></pre>
<p>再次 <code>amplify push</code>， 提示 <code>[webClientId, nativeClientId, userPooId] does not exist in the template</code>。</p>
<pre><code class="language-shell">UPDATE_FAILED auth&lt;appName&gt; AWS::CloudFormation::Stack &lt;TIME&gt; Parameters: [webClientId, nativeClientId, userPoolId] do not exist in the template
</code></pre>
<p>看起来只是 <code>/amplify/backend/auth/&lt;appName&gt;/&lt;appName&gt;-cloudformation-template.yml</code> 没配好。我还没 commit my changes，直接用了上一个 commit 的 <code>yaml</code>：</p>
<pre><code class="language-shell">git checkout &lt;commit-hash&gt; -- ./amplify/backend/auth/&lt;appName&gt;/&lt;appName&gt;-cloudformation-template.yml
</code></pre>
<p>再进行一次 <code>amplify push</code>……好像还是不行。</p>
<p>那我 <code>amplify update auth</code> 呢？反正现在 <code>dev</code> 是空的。走了一遍流程尽量什么也没改：</p>
<pre><code class="language-shell"># Match: repoName on develop [Node.js 14.18.1] ❯ amplify update auth
Please note that certain attributes may not be overwritten if you choose to use defaults settings.

You have configured resources that might depend on this Cognito resource.  Updating this Cognito resource could have unintended side effects.

√ A migration is needed to support latest updates on auth resources.
Recommended to try in a non-production environment first. Run &quot;amplify env add&quot; to create or clone an environment.
Learn more about this migration: https://docs.amplify.aws/cli/migration/override
Do you want to migrate auth resource &quot;&lt;appName&gt;&quot;? (Y/n) · no
Using service: Cognito, provided by: awscloudformation
 What do you want to do? Walkthrough all the auth configurations
 Select the authentication/authorization services that you want to use: User Sign-Up, Sign-In, connected with AWS IAM
 controls (Enables per-user Storage features for images or other content, Analytics, and more)
 Allow unauthenticated logins? (Provides scoped down permissions that you can control via AWS IAM) No
 Do you want to enable 3rd party authentication providers in your identity pool? No
 Do you want to add User Pool Groups? No
 Do you want to add an admin queries API? No
 Multifactor authentication (MFA) user login options: OFF
 Email based user registration/forgot password: Enabled (Requires per-user email entry at registration)
 Specify an email verification subject: [ArtApp] Request to confirm your email address
 Specify an email verification message: Confirm your email address
Your confirmation code is below -- enter it in your app and we'll help you get signed in.

{####}

If you didn't request the mail, there's nothing to worry about -- you can safely ignore it.
 Do you want to override the default password policy for this User Pool? No
 Specify the app's refresh token expiration period (in days): 30
 Do you want to specify the user attributes this app can read and write? No
 Do you want to enable any of the following capabilities?
 Do you want to use an OAuth flow? Yes
 What domain name prefix do you want to use? 3gz4lx4uwbff
 Which redirect signin URIs do you want to edit?
 Do you want to add redirect signin URIs? No
 Which redirect signout URIs do you want to edit?
 Do you want to add redirect signout URIs? No
 Select the OAuth flows enabled for this project. Authorization code grant
 Select the OAuth scopes enabled for this project. Phone, Email, OpenID, Profile, aws.cognito.signin.user.admin
 Select the identity providers you want to configure for your user pool: Facebook, Google

 You've opted to allow users to authenticate via Facebook.  If you haven't already, you'll need to go to https://deve
lopers.facebook.com and create an App ID.

 Enter your Facebook App ID for your OAuth flow:  test
 Enter your Facebook App Secret for your OAuth flow:  test

 You've opted to allow users to authenticate via Google.  If you haven't already, you'll need to go to https://develo
pers.google.com/identity and create an App ID.

 Enter your Google Web Client ID for your OAuth flow:  test
 Enter your Google Web Client Secret for your OAuth flow:  test
? Do you want to configure Lambda Triggers for Cognito? Yes
? Which triggers do you want to enable for Cognito
✅ Successfully updated auth resource &lt;appName&gt; locally

✅ Some next steps:
&quot;amplify push&quot; will build all your local backend resources and provision it in the cloud
&quot;amplify publish&quot; will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud

✅ Successfully updated resource update locally

✅ Some next steps:
&quot;amplify push&quot; will build all your local backend resources and provision it in the cloud
&quot;amplify publish&quot; will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud
</code></pre>
<p>再 <code>amplify push</code> 一次，还是不行。删了重开吧，这次不在 amplify console 做了。</p>
<pre><code class="language-shell"> ❯ amplify env add
Note: It is recommended to run this command from the root of your app directory
? Enter a name for the environment dev
Using default provider  awscloudformation
? Select the authentication method you want to use: Amplify Admin UI
Adding backend environment dev to AWS Amplify Console app: d1e84vh5xbcfwc
\ Initializing project in the cloud...
</code></pre>
<p>好像啥也挺成功的…… 再次尝试 <code>amplify push</code></p>
<pre><code class="language-shell">amplify push --yes
</code></pre>
<p>报错 <code>Error: File at path: 'amplify/backend/auth/&lt;appName&gt;/build/parameters.json' does not exist'</code>，看了一下虽然没有 <code>build</code> 但有 <code>parameters.json</code>…… 创建个路径试一下？ —— 终于成功了。很可能是 aws-amplify 版本不同的锅。</p>
<h3 id="总结"><a class="header" href="#总结">总结</a></h3>
<ol>
<li>千万不要随便更新 <code>aws-amplify</code> 版本，配置文件很可能位置会变</li>
<li>最好不要在 AWS Amplify Console 创建环境。</li>
</ol>
<p>正确的基于已存环境创建新环境的做法是 <strong>使用 Amplify CLI</strong> 在有配置文件的分支创建 environment 然后 push。</p>
<pre><code class="language-bash">amplify env add
amplify push --yes
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../devops/hadoop-on-k8s.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Linux/disk-management.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../devops/hadoop-on-k8s.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Linux/disk-management.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
